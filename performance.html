<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>M5StickC 足組み判定（45/90→N戻り対応）</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #eaf7f3;
      color: #004d40;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 { background:#a7ffeb; padding:10px; margin:0; }
    #result { font-size: 24px; font-weight: bold; margin-top: 20px; }
    #styleLabel { font-size:18px; margin-top:5px; }
    table {
      margin:20px auto;
      border-collapse: collapse;
      width:90%;
      max-width:700px;
    }
    th, td {
      border:1px solid #80cbc4;
      padding:8px;
      font-size:14px;
    }
    th { background:#b2dfdb; }
    .small { font-size:12px; color:#00796b; }
  </style>
</head>

<body>

<h1>M5StickC 足組み判定（45/90→N戻り対応 完全版）</h1>

<p id="result">状態: -</p>
<p id="styleLabel">組み方: -</p>

<table>
  <tr>
    <th>項目</th>
    <th>右足</th>
    <th>左足</th>
  </tr>
  <tr>
    <td>Pitch</td><td id="rp">0</td><td id="lp">0</td>
  </tr>
  <tr>
    <td>Roll</td><td id="rr">0</td><td id="lr">0</td>
  </tr>
  <tr>
    <td>Vec</td><td id="rv">0</td><td id="lv">0</td>
  </tr>
  <tr>
    <td>Δ (Vec - 初期)</td><td id="rd">0</td><td id="ld">0</td>
  </tr>
  <tr>
    <td>レベル</td><td id="rlevel">-</td><td id="llevel">-</td>
  </tr>
  <tr>
    <td class="small">初期値</td><td id="rbase">0</td><td id="lbase">0</td>
  </tr>
</table>

<script>
/* ---------------------------------------------------------
   初期値
--------------------------------------------------------- */
let base = {
  right: 24.524,
  left: 24.524
};

document.getElementById("rbase").textContent = base.right.toFixed(3);
document.getElementById("lbase").textContent = base.left.toFixed(3);

/* ---------------------------------------------------------
   足組判定設定
--------------------------------------------------------- */
const th25 = 25;   // 45°
const th50 = 63.679; // 90°
const neutralRange = 7; // ±7以内で戻り判定
const holdMs = 3000; // 3秒

// 右・左 足組み開始時間
let exceed = {
  right25: null,
  right50: null,
  left25: null,
  left50: null
};

// N に戻るための中立判定タイマー
let neutral = {
  right: null,
  left: null
};

/* ---------------------------------------------------------
   BLE 受信処理
--------------------------------------------------------- */
window.addEventListener("DOMContentLoaded", () => {

  if (!("bluetooth" in navigator)) {
    alert("Bluetooth未対応ブラウザです");
    return;
  }

  navigator.bluetooth.requestDevice({
    filters: [{ services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"] }]
  })
  .then(device => device.gatt.connect())
  .then(server => server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b"))
  .then(service => service.getCharacteristic("beb5483e-36e1-4688-b7f5-ea073f74076a"))
  .then(ch => {
    ch.startNotifications().then(_ => {
      ch.addEventListener("characteristicvaluechanged", handleData);
    });
  })
  .catch(e => alert("接続エラー: " + e));
});

/* ---------------------------------------------------------
   受信データ処理
--------------------------------------------------------- */
function handleData(event) {
  const txt = new TextDecoder().decode(event.target.value);
  if (!txt.includes(",")) return;

  const sp = txt.split(",");
  if (sp.length < 6) return;

  let rP = parseFloat(sp[0]);
  let rR = parseFloat(sp[1]);
  let rV = parseFloat(sp[2]);

  let lP = parseFloat(sp[3]);
  let lR = parseFloat(sp[4]);
  let lV = parseFloat(sp[5]);

  document.getElementById("rp").textContent = rP.toFixed(1);
  document.getElementById("rr").textContent = rR.toFixed(1);
  document.getElementById("rv").textContent = rV.toFixed(3);

  document.getElementById("lp").textContent = lP.toFixed(1);
  document.getElementById("lr").textContent = lR.toFixed(1);
  document.getElementById("lv").textContent = lV.toFixed(3);

  let rΔ = rV - base.right;
  let lΔ = lV - base.left;

  document.getElementById("rd").textContent = rΔ.toFixed(3);
  document.getElementById("ld").textContent = lΔ.toFixed(3);

  checkState(rΔ, lΔ);
}

/* ---------------------------------------------------------
   判定処理（45 / 90 / 戻り処理）
--------------------------------------------------------- */
function checkState(rΔ, lΔ) {
  const now = performance.now();

  /* -------------------------------
     ① N に戻る中立判定
     rΔ と lΔ が ±7 以内→3秒維持
  ------------------------------- */
  let rightNeutral = Math.abs(rΔ) <= neutralRange;
  let leftNeutral  = Math.abs(lΔ) <= neutralRange;

  if (rightNeutral) {
    if (!neutral.right) neutral.right = now;
  } else {
    neutral.right = null;
  }

  if (leftNeutral) {
    if (!neutral.left) neutral.left = now;
  } else {
    neutral.left = null;
  }

  // 両足とも3秒以内なら完全にNに戻る
  if (neutral.right && neutral.left &&
      now - neutral.right >= holdMs &&
      now - neutral.left  >= holdMs) {

    document.getElementById("result").textContent = "状態: 足を組んでいません";
    document.getElementById("result").style.background = "#C8E6C9";
    document.getElementById("styleLabel").textContent = "組み方: -";
    document.getElementById("rlevel").textContent = "-";
    document.getElementById("llevel").textContent = "-";
    return;
  }

  /* -------------------------------
     ② 足組み（45 / 90）の保持判定
  ------------------------------- */

  // 右足
  if (Math.abs(rΔ) >= th50) {
    if (!exceed.right50) exceed.right50 = now;
  } else {
    exceed.right50 = null;
  }

  if (Math.abs(rΔ) >= th25) {
    if (!exceed.right25) exceed.right25 = now;
  } else {
    exceed.right25 = null;
  }

  // 左足
  if (Math.abs(lΔ) >= th50) {
    if (!exceed.left50) exceed.left50 = now;
  } else {
    exceed.left50 = null;
  }

  if (Math.abs(lΔ) >= th25) {
    if (!exceed.left25) exceed.left25 = now;
  } else {
    exceed.left25 = null;
  }

  /* -------------------------------
     ③ 状態決定
  ------------------------------- */
  let rightLevel = "-";
  let leftLevel = "-";

  if (exceed.right50 && now - exceed.right50 >= holdMs) rightLevel = "90°";
  else if (exceed.right25 && now - exceed.right25 >= holdMs) rightLevel = "45°";

  if (exceed.left50 && now - exceed.left50 >= holdMs) leftLevel = "90°";
  else if (exceed.left25 && now - exceed.left25 >= holdMs) leftLevel = "45°";

  document.getElementById("rlevel").textContent = rightLevel;
  document.getElementById("llevel").textContent = leftLevel;

  // 表示
  if (rightLevel === "-" && leftLevel === "-") {
    document.getElementById("result").textContent = "状態: 足を組んでいません";
    document.getElementById("result").style.background = "#C8E6C9";
    document.getElementById("styleLabel").textContent = "組み方: -";
  } else {
    document.getElementById("result").textContent = "状態: 足を組んでいます";
    document.getElementById("result").style.background = "#FFCC80";
    document.getElementById("styleLabel").textContent =
      (rightLevel !== "-" ? "右 " + rightLevel : "") +
      (leftLevel !== "-" ? " ／ 左 " + leftLevel : "");
  }
}

</script>
</body>
</html>
