<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>M5StickC 足組み判定（Arduino判定版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#eaf7f3;
      color:#004d40;
      text-align:center;
      margin:0;
      padding:16px;
    }
    h1 {
      background:#a7ffeb;
      padding:16px;
      border-radius:12px;
    }
    button {
      font-size:16px;
      padding:10px 18px;
      margin:10px;
      border:none;
      border-radius:10px;
      background:#26a69a;
      color:#fff;
      cursor:pointer;
    }
    #status, #phase {
      font-size:22px;
      font-weight:bold;
      margin-top:14px;
    }
    #phase {
      font-size:48px;
      padding:18px 28px;
      border-radius:16px;
      display:inline-block;
      margin-top:20px;
      background:#ffffff;
    }
    pre {
      text-align:left;
      max-width:420px;
      margin:20px auto;
      background:#b2dfdb;
      padding:12px;
      border-radius:10px;
      font-size:14px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>M5StickC 足組み判定</h1>

<button onclick="connect()">BLE 接続</button>
<button onclick="downloadExcel()">Excel ダウンロード</button>

<div id="status">未接続</div>

<div id="phase">—</div>

<pre id="log"></pre>

<script>
/* ===== UUID ===== */
const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const charUUID    = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* ===== ログ ===== */
let logData = [["Time","Phase"]];
const logEl = document.getElementById("log");

/* ===== BLE 接続 ===== */
async function connect(){
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[serviceUUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUUID);
    const char = await service.getCharacteristic(charUUID);

    await char.startNotifications();

    document.getElementById("status").textContent = "接続中：通知待ち";

    char.addEventListener("characteristicvaluechanged", e=>{
      const phase = new TextDecoder().decode(e.target.value).trim();
      updatePhase(phase);
    });

  } catch(err){
    document.getElementById("status").textContent = "接続失敗: " + err;
  }
}

/* ===== 表示更新 ===== */
function updatePhase(phase){
  const phaseEl = document.getElementById("phase");
  phaseEl.textContent = phase;

  // 色分け
  if(phase === "90"){
    phaseEl.style.background = "#FFAB91";
  } else if(phase === "45"){
    phaseEl.style.background = "#FFE082";
  } else if(phase === "N"){
    phaseEl.style.background = "#C5E1A5";
  } else {
    phaseEl.style.background = "#E0E0E0";
  }

  const time = new Date().toLocaleTimeString();
  logData.push([time, phase]);

  logEl.textContent =
    logData.slice(-10).map(r=>`${r[0]}  :  ${r[1]}`).join("\n");
}

/* ===== Excel ===== */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, ws, "LegJudge");
  XLSX.writeFile(wb, "leg_crossing_result.xlsx");
}
</script>

</body>
</html>
