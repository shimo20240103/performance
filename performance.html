<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>M5StickC 足組み判定（合成値ベース）</title>

  <style>
    body { font-family: 'Arial', sans-serif; background:#eaf7f3; color:#004d40; text-align:center; margin:0; padding:0; }
    h1 { background:#a7ffeb; margin:0; padding:15px; }
    #status { font-size: 30px; font-weight: bold; margin: 20px; }
    #connectBtn { padding: 14px 24px; background:#009688; color:white; border:none; border-radius:12px; font-size:18px; cursor:pointer; }
    .graph-container { display:flex; justify-content:space-around; margin:20px; }
    canvas { background:white; border-radius:12px; }
  </style>

</head>
<body>

  <h1>M5StickC 足組み判定（合成値ベース）</h1>
  <button id="connectBtn">M5StickC と接続</button>

  <div id="status">未接続</div>

  <div class="graph-container">
    <div>
      <p>右足 合成値</p>
      <canvas id="rightChart" width="350" height="200"></canvas>
    </div>
    <div>
      <p>左足 合成値</p>
      <canvas id="leftChart" width="350" height="200"></canvas>
    </div>
  </div>

  <p id="judge" style="font-size:28px; font-weight:bold; margin-top:20px;">判定：なし</p>

  <script>

    let device, characteristic;

    // ▼ 判定閾値
    const threshold45 = 20;   // ←ここを 20 に変更
    const threshold90 = 50;

    // ▼ 3秒カウンター
    let rightCount45 = 0, leftCount45 = 0;
    let rightCount90 = 0, leftCount90 = 0;

    // ▼ グラフ用バッファ
    let rightData = [];
    let leftData = [];
    const maxPoints = 50;

    // ▼ グラフ描画
    const rightCtx = document.getElementById("rightChart").getContext("2d");
    const leftCtx  = document.getElementById("leftChart").getContext("2d");

    function drawGraph(ctx, data) {
        ctx.clearRect(0,0,350,200);
        ctx.beginPath();
        ctx.moveTo(0, 200 - data[0]);

        for (let i = 1; i < data.length; i++) {
            ctx.lineTo(i * (350/maxPoints), 200 - data[i]);
        }
        ctx.stroke();
    }

    // ▼ BLE 接続
    document.getElementById("connectBtn").onclick = async () => {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"] }]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
        characteristic = await service.getCharacteristic("beb5483e-36e1-4688-b7f5-ea073f74076a");

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", onData);
        document.getElementById("status").textContent = "接続完了";

      } catch(e) {
        alert("接続失敗: " + e);
      }
    };

    // ▼ データ受信処理
    function onData(event) {
      let text = new TextDecoder().decode(event.target.value);
      let s = text.split(",");

      if (s.length < 4) return;

      let pitchR = parseFloat(s[0]);
      let rollR  = parseFloat(s[1]);
      let pitchL = parseFloat(s[2]);
      let rollL  = parseFloat(s[3]);

      // 合成値計算
      let rightVec = Math.sqrt(pitchR*pitchR + rollR*rollR);
      let leftVec  = Math.sqrt(pitchL*pitchL + rollL*rollL);

      // --- グラフ更新 ---
      rightData.push(rightVec);
      leftData.push(leftVec);

      if (rightData.length > maxPoints) rightData.shift();
      if (leftData.length > maxPoints) leftData.shift();

      drawGraph(rightCtx, rightData);
      drawGraph(leftCtx, leftData);

      // --- 判定処理 ---
      judgeAngle(rightVec, leftVec);
    }

    function judgeAngle(r, l) {
      let result = "なし";

      // ▼ 90度（50以上・3秒）
      if (r > threshold90) rightCount90++; else rightCount90 = 0;
      if (l > threshold90) leftCount90++;  else leftCount90 = 0;

      if (rightCount90 >= 3) result = "右 90°";
      if (leftCount90  >= 3) result = "左 90°";

      // ▼ 45度（20以上・3秒）
      // ※ 90°が勝つので最後に書かない
      if (r > threshold45) rightCount45++; else rightCount45 = 0;
      if (l > threshold45) leftCount45++;  else leftCount45 = 0;

      if (result === "なし") {
        if (rightCount45 >= 3) result = "右 45°";
        if (leftCount45  >= 3) result = "左 45°";
      }

      document.getElementById("judge").textContent = "判定：" + result;
    }

  </script>

</body>
</html>
